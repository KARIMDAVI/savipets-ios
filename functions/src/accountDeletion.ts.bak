/**
 * Account Deletion Cloud Functions
 * 
 * This file contains Cloud Functions for:
 * 1. Sending deletion confirmation emails
 * 2. Scheduled cleanup of accounts after 30-day grace period
 * 3. Sending reminders before permanent deletion
 */

import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import * as nodemailer from 'nodemailer';

// Initialize Firebase Admin if not already initialized
if (!admin.apps.length) {
  admin.initializeApp();
}

const db = admin.firestore();
const auth = admin.auth();

// Email configuration (use environment variables in production)
const emailConfig = {
  service: 'gmail', // or 'sendgrid', 'mailgun', etc.
  auth: {
    user: functions.config().email?.user || process.env.EMAIL_USER,
    pass: functions.config().email?.pass || process.env.EMAIL_PASS,
  },
};

const transporter = nodemailer.createTransporter(emailConfig);

// MARK: - Email Templates

interface DeletionEmailData {
  email: string;
  deletionDate: string;
  gracePeriodDays: number;
}

interface ReminderEmailData {
  email: string;
  deletionDate: string;
  daysRemaining: number;
}

function generateDeletionScheduledEmail(data: DeletionEmailData): string {
  return `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #ff3b30; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background-color: #f9f9f9; padding: 30px; border-radius: 0 0 8px 8px; }
        .warning { background-color: #fff3cd; border-left: 4px solid: #ffc107; padding: 15px; margin: 20px 0; }
        .button { background-color: #34c759; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 20px 0; }
        .footer { text-align: center; color: #666; font-size: 12px; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêæ SaviPets Account Deletion Scheduled</h1>
        </div>
        <div class="content">
            <p>Hello,</p>
            
            <p>We've received your request to delete your SaviPets account.</p>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong> Your account is scheduled for permanent deletion on <strong>${data.deletionDate}</strong>.
            </div>
            
            <h2>What happens next?</h2>
            <ul>
                <li>‚úÖ You can continue using SaviPets for the next ${data.gracePeriodDays} days</li>
                <li>‚úÖ You can cancel this deletion at any time from your Profile settings</li>
                <li>‚è∞ We'll send you a reminder 7 days before deletion</li>
                <li>‚ùå After ${data.deletionDate}, your data will be permanently deleted</li>
            </ul>
            
            <h2>Want to keep your account?</h2>
            <p>Simply sign in to the app and go to Profile ‚Üí Cancel Deletion.</p>
            
            <a href="savipets://profile" class="button">Open SaviPets</a>
            
            <h2>What gets deleted?</h2>
            <ul>
                <li>Your profile and account information</li>
                <li>All pet profiles and photos</li>
                <li>Your location data</li>
                <li>Booking history (anonymized after deletion)</li>
            </ul>
            
            <p>If you didn't request this deletion, please contact us immediately at support@savipets.com</p>
            
            <p>Thank you for using SaviPets! üêæ</p>
        </div>
        <div class="footer">
            <p>SaviPets - Professional Pet Care Services</p>
            <p>This is an automated message, please do not reply.</p>
        </div>
    </div>
</body>
</html>
  `;
}

function generateReminderEmail(data: ReminderEmailData): string {
  return `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #ff9500; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background-color: #f9f9f9; padding: 30px; border-radius: 0 0 8px 8px; }
        .urgent { background-color: #ff3b30; color: white; padding: 15px; margin: 20px 0; border-radius: 8px; text-align: center; }
        .button { background-color: #34c759; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 20px 0; }
        .footer { text-align: center; color: #666; font-size: 12px; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚è∞ ${data.daysRemaining} Days Until Account Deletion</h1>
        </div>
        <div class="content">
            <p>Hello,</p>
            
            <div class="urgent">
                <h2 style="margin: 0;">üö® Your account will be deleted on ${data.deletionDate}</h2>
                <p style="margin: 10px 0 0 0;">Only ${data.daysRemaining} days remaining!</p>
            </div>
            
            <p>This is a friendly reminder that your SaviPets account is scheduled for permanent deletion.</p>
            
            <h2>Want to keep your account?</h2>
            <p><strong>It's not too late!</strong> You can cancel the deletion and keep your account by:</p>
            <ol>
                <li>Opening the SaviPets app</li>
                <li>Going to your Profile</li>
                <li>Tapping "Cancel Deletion & Keep Account"</li>
            </ol>
            
            <a href="savipets://profile" class="button">Open SaviPets & Keep My Account</a>
            
            <h2>What happens if I do nothing?</h2>
            <p>On <strong>${data.deletionDate}</strong>, your account and all associated data will be permanently deleted:</p>
            <ul>
                <li>‚ùå Profile and login credentials</li>
                <li>‚ùå All pet profiles</li>
                <li>‚ùå Location history</li>
                <li>‚ùå Booking records</li>
            </ul>
            
            <p><strong>This action cannot be undone.</strong></p>
            
            <p>Questions? Contact us at support@savipets.com</p>
        </div>
        <div class="footer">
            <p>SaviPets - Professional Pet Care Services</p>
            <p>This is an automated message, please do not reply.</p>
        </div>
    </div>
</body>
</html>
  `;
}

// MARK: - Cloud Functions

/**
 * Send deletion confirmation email when account deletion is scheduled
 * Triggered by new documents in the 'mail' collection
 */
export const sendDeletionEmail = functions.firestore
  .document('mail/{mailId}')
  .onCreate(async (snapshot, context) => {
    const mailData = snapshot.data();
    
    // Only process deletion confirmation emails
    if (mailData.template?.name !== 'accountDeletionScheduled') {
      return null;
    }
    
    try {
      const emailHtml = generateDeletionScheduledEmail({
        email: mailData.to,
        deletionDate: mailData.template.data.deletionDate,
        gracePeriodDays: mailData.template.data.gracePeriodDays,
      });
      
      await transporter.sendMail({
        from: '"SaviPets" <noreply@savipets.com>',
        to: mailData.to,
        subject: 'üêæ SaviPets Account Deletion Scheduled',
        html: emailHtml,
      });
      
      // Mark email as sent
      await snapshot.ref.update({
        status: 'sent',
        sentAt: admin.firestore.FieldValue.serverTimestamp(),
      });
      
      console.log(`Deletion confirmation email sent to ${mailData.to}`);
      return null;
      
    } catch (error) {
      console.error('Error sending deletion email:', error);
      
      // Mark email as failed
      await snapshot.ref.update({
        status: 'failed',
        error: String(error),
        failedAt: admin.firestore.FieldValue.serverTimestamp(),
      });
      
      throw error;
    }
  });

/**
 * Send reminder emails 7 days before deletion
 * Run daily via Cloud Scheduler
 */
export const sendDeletionReminders = functions.pubsub
  .schedule('every day 09:00')
  .timeZone('America/New_York')
  .onRun(async (context) => {
    const now = admin.firestore.Timestamp.now();
    const sevenDaysFromNow = new Date();
    sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
    const sevenDaysTimestamp = admin.firestore.Timestamp.fromDate(sevenDaysFromNow);
    
    // Find accounts scheduled for deletion in 7 days
    const snapshot = await db.collection('accountDeletions')
      .where('status', '==', 'scheduled')
      .where('scheduledFor', '<=', sevenDaysTimestamp)
      .where('scheduledFor', '>', now)
      .get();
    
    console.log(`Found ${snapshot.size} accounts to send reminders to`);
    
    const promises = snapshot.docs.map(async (doc) => {
      const deletionData = doc.data();
      
      // Check if reminder already sent
      if (deletionData.reminderSent) {
        return;
      }
      
      try {
        const deletionDate = deletionData.scheduledFor.toDate();
        const daysRemaining = Math.ceil(
          (deletionDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24)
        );
        
        const emailHtml = generateReminderEmail({
          email: deletionData.email,
          deletionDate: deletionDate.toLocaleDateString(),
          daysRemaining,
        });
        
        await transporter.sendMail({
          from: '"SaviPets" <noreply@savipets.com>',
          to: deletionData.email,
          subject: `‚è∞ ${daysRemaining} Days Until Your Account is Deleted`,
          html: emailHtml,
        });
        
        // Mark reminder as sent
        await doc.ref.update({
          reminderSent: true,
          reminderSentAt: admin.firestore.FieldValue.serverTimestamp(),
        });
        
        console.log(`Reminder sent to ${deletionData.email}`);
        
      } catch (error) {
        console.error(`Error sending reminder to ${deletionData.email}:`, error);
      }
    });
    
    await Promise.all(promises);
    return null;
  });

/**
 * Execute permanent account deletion after grace period
 * Run daily via Cloud Scheduler
 */
export const executeScheduledDeletions = functions.pubsub
  .schedule('every day 02:00')
  .timeZone('America/New_York')
  .onRun(async (context) => {
    const now = admin.firestore.Timestamp.now();
    
    // Find accounts scheduled for deletion that have passed their deletion date
    const snapshot = await db.collection('accountDeletions')
      .where('status', '==', 'scheduled')
      .where('scheduledFor', '<=', now)
      .get();
    
    console.log(`Found ${snapshot.size} accounts to delete permanently`);
    
    const promises = snapshot.docs.map(async (doc) => {
      const deletionData = doc.data();
      const userId = deletionData.userId;
      
      try {
        console.log(`Deleting account for user: ${userId}`);
        
        // 1. Delete from Firebase Auth
        try {
          await auth.deleteUser(userId);
          console.log(`Deleted auth user: ${userId}`);
        } catch (error: any) {
          if (error.code !== 'auth/user-not-found') {
            throw error;
          }
          console.log(`Auth user already deleted: ${userId}`);
        }
        
        // 2. Delete user profile
        await db.collection('users').doc(userId).delete();
        
        // 3. Delete public profile
        await db.collection('publicProfiles').doc(userId).delete();
        
        // 4. Delete pets
        const petsPath = `artifacts/savipets-72a88/users/${userId}/pets`;
        const petsSnapshot = await db.collection(petsPath).get();
        const deletePetsPromises = petsSnapshot.docs.map((petDoc) => petDoc.ref.delete());
        await Promise.all(deletePetsPromises);
        
        // 5. Delete staff profile
        const staffPath = `artifacts/savipets-72a88/users/${userId}/staff/${userId}`;
        await db.doc(staffPath).delete();
        
        // 6. Delete location data
        await db.collection('locations').doc(userId).delete();
        
        // 7. Cancel pending bookings
        const bookingsSnapshot = await db.collection('serviceBookings')
          .where('clientId', '==', userId)
          .where('status', 'in', ['pending', 'approved'])
          .get();
        
        const cancelBookingsPromises = bookingsSnapshot.docs.map((bookingDoc) =>
          bookingDoc.ref.update({
            status: 'canceled',
            canceledAt: admin.firestore.FieldValue.serverTimestamp(),
            canceledReason: 'Account deleted',
          })
        );
        await Promise.all(cancelBookingsPromises);
        
        // 8. Mark deletion as completed
        await doc.ref.update({
          status: 'completed',
          completedAt: admin.firestore.FieldValue.serverTimestamp(),
        });
        
        // 9. Send final confirmation email
        const emailHtml = `
          <h1>Your SaviPets account has been deleted</h1>
          <p>This confirms that your account and all associated data have been permanently removed from our system.</p>
          <p>If you did not request this deletion, please contact support@savipets.com immediately.</p>
        `;
        
        await transporter.sendMail({
          from: '"SaviPets" <noreply@savipets.com>',
          to: deletionData.email,
          subject: 'Your SaviPets account has been deleted',
          html: emailHtml,
        });
        
        console.log(`Successfully deleted account for user: ${userId}`);
        
      } catch (error) {
        console.error(`Error deleting account for user ${userId}:`, error);
        
        // Mark deletion as failed
        await doc.ref.update({
          status: 'failed',
          error: String(error),
          failedAt: admin.firestore.FieldValue.serverTimestamp(),
        });
      }
    });
    
    await Promise.all(promises);
    return null;
  });

/**
 * Clean up old deletion records (completed/failed deletions older than 90 days)
 * Run monthly via Cloud Scheduler
 */
export const cleanupDeletionRecords = functions.pubsub
  .schedule('0 0 1 * *') // First day of each month
  .timeZone('America/New_York')
  .onRun(async (context) => {
    const ninetyDaysAgo = new Date();
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
    const cutoffTimestamp = admin.firestore.Timestamp.fromDate(ninetyDaysAgo);
    
    const snapshot = await db.collection('accountDeletions')
      .where('status', 'in', ['completed', 'failed'])
      .where('completedAt', '<=', cutoffTimestamp)
      .get();
    
    console.log(`Cleaning up ${snapshot.size} old deletion records`);
    
    const promises = snapshot.docs.map((doc) => doc.ref.delete());
    await Promise.all(promises);
    
    return null;
  });

